<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>topIDEB ‚Äî Leitura Cr√≠tica (EM)</title>
  <style>
    :root{
      --bg1:#eaf3ff;           /* azul suave */
      --bg2:#fff5f5;           /* vermelho clarinho */
      --card:rgba(255,255,255,0.92);
      --ink:#20324a;
      --muted:#6e8096;
      --accent:#5a9bd8;
      --accent-2:#7fb7ff;
      --ok:#eaf3ff;
      --no:#ffefed;
      --warn:#e28989;
      --chip:rgba(255,255,255,0.65);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;}
    #app{ width:min(960px,100%); background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(15,41,66,.12); overflow:hidden; }
    header{ padding:18px 20px; background:linear-gradient(180deg,rgba(240,248,255,0.88),rgba(255,255,255,0.78)); border-bottom:1px solid rgba(229,238,251,0.6);
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:12px; }
    h1{ font-size:1.15rem; margin:0; letter-spacing:.2px }
    .logo{ width:38px; height:38px; border-radius:10px;
      background:conic-gradient(from 210deg at 50% 50%, var(--accent), #b5d2f2, #ffdcdc, var(--accent));
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.8); }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input{padding:10px 12px; border:1px solid #cddff5; border-radius:10px; background:rgba(255,255,255,0.7); outline:none; font-size:.95rem;}
    button{cursor:pointer; border:none; border-radius:10px; padding:10px 14px; font-weight:600; letter-spacing:.2px; }
    .primary{ background:var(--accent); color:#fff; }
    .ghost{ background:rgba(255,255,255,0.7); color:var(--accent); border:1px solid #cddff5 }
    .danger{ background:var(--warn); color:#fff }

    .subtitle{ font-size:.9rem; color:var(--muted); }

    main{ padding:20px; display:grid; gap:16px; }
    .status{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px; }
    .chip{ background:var(--chip); padding:10px 12px; border-radius:999px; font-size:.88rem; text-align:center; border:1px solid #cddff5; }
    .chip strong{ font-weight:700 }
    .chip.alert{ background:rgba(255,235,233,0.9); border-color:#ffc2bd; color:#7a1f1f }

    .card{ background:rgba(255,255,255,0.92); border:1px solid #d7e4f7; border-radius:14px; padding:16px; }
    .question{ font-weight:700; margin:12px 0 6px; font-size:1.05rem; }
    .answers{ display:grid; gap:10px; margin-top:10px }
    .ans{ text-align:left; padding:14px 16px; border:2px solid #d7e4f7; background:rgba(255,255,255,0.9); border-radius:12px; transition:.15s; }
    .ans:hover{ border-color:var(--accent-2); background:rgba(240,248,255,0.95) }
    .ans.ok{ background:var(--ok); border-color:#a8c7ff }
    .ans.no{ background:var(--no); border-color:#ffb5ae }

    .explain{ margin-top:10px; font-size:1rem; background:rgba(242,248,255,0.94); border:1px solid #cddff5; border-radius:10px; padding:12px; display:none }
    .explain.ok{ color:#21405f; background:#eaf3ff; border-color:#a8c7ff }
    .explain.no{ color:#6b1f1f; background:#ffefed; border-color:#ffc2bd }

    .footer{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap }
    .hidden{display:none!important}
    .ranking{ padding:0; margin:0; list-style:none }
    .ranking li{ padding:6px 0; border-bottom:1px dashed #cddff5 }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="brand"><div class="logo"></div><h1>topIDEB</h1></div>
      <div class="controls">
        <input id="student" type="text" placeholder="Nome do(a) aluno(a)" maxlength="24" />
        <button id="start" class="primary">Come√ßar</button>
        <button id="restart" class="ghost hidden">Reiniciar</button>
      </div>
    </header>

    <main>
      <section class="status">
        <div class="chip">Pontua√ß√£o: <strong id="score">0</strong></div>
        <div class="chip">Vidas: <strong id="lives">‚ù§‚ù§‚ù§</strong></div>
        <div class="chip" id="timeChip">Tempo: <strong id="time">‚Äì</strong></div>
        <div class="chip">Ranking (Top 10)</div>
      </section>

      <div class="card">
        <div id="context">Digite o nome e clique em <strong>Come√ßar</strong>. S√£o <strong>3 fases</strong> (F√°cil, M√©dia, Dif√≠cil), com <strong>8 quest√µes</strong> cada. O descritor de cada quest√£o aparece logo abaixo do enunciado.</div>
        <div id="question" class="question"></div>
        <div id="descriptor" class="subtitle" style="font-weight:700"></div>
        <div id="answers" class="answers"></div>
        <div id="explain" class="explain"></div>
        <div class="footer">
          <div id="progress"></div>
          <div>
            <button id="saveScore" class="ghost hidden">Salvar pontua√ß√£o</button>
            <button id="resetRanking" class="danger">Zerar Ranking</button>
          </div>
        </div>
      </div>

      <div class="card">
        <ul id="ranking" class="ranking"></ul>
      </div>
    </main>
  </div>

  <script>
// ===== topIDEB ‚Äì 3 fases (F√°cil, M√©dia, Dif√≠cil) com sele√ß√£o aleat√≥ria e banner de transi√ß√£o =====
const PHASES = [
  { name:'F√°cil', items:[
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'"O campeonato come√ßa dia 12 de maio."', q:'Qual √© a data de in√≠cio?', a:['10 de maio','12 de maio','15 de maio','20 de maio'], c:1, e:'Informa√ß√£o literal: 12 de maio.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Cartaz: "Show √†s 19h no Teatro Municipal"', q:'Qual √© o hor√°rio do show?', a:['18h','19h','20h','21h'], c:1, e:'Est√° dito: 19h.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Aviso: "Inscri√ß√µes de 1¬∫ a 7 de setembro"', q:'Per√≠odo das inscri√ß√µes:', a:['1¬∫‚Äì5','1¬∫‚Äì7','2‚Äì8','7‚Äì14'], c:1, e:'Literal: 1¬∫ a 7.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Relat√≥rio: "Foram coletadas 250 amostras no trimestre"', q:'Quantas amostras foram coletadas?', a:['150','200','250','300'], c:2, e:'N√∫mero informado: 250.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Boletim: "A m√©dia passou de 5,4 para 6,1"', q:'Qual era a m√©dia anterior?', a:['5,0','5,2','5,4','5,6'], c:2, e:'Anterior: 5,4.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Jo√£o saiu com guarda-chuva ao ver o c√©u nublado.', q:'O que se infere?', a:['Vai ventar','Pode chover','Vai fazer sol','Haver√° neblina'], c:1, e:'Guarda-chuva + nublado ‚Üí chance de chuva.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Maria acendeu a luz ao entrar.', q:'Como estava a sala?', a:['Clara','Escura','Lotada','Decorada'], c:1, e:'Se acendeu, estava escura.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Ao soar o sinal, os alunos guardaram os cadernos e se levantaram.', q:'O que se infere?', a:['A aula come√ßou','A aula terminou','Houve prova','Professor faltou'], c:1, e:'Rotina de encerramento.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"A biblioteca recebeu 200 livros."', q:'Qual op√ß√£o √© fato?', a:['A biblioteca ficou incr√≠vel','Chegaram 200 livros','Os livros s√£o √≥timos','Foi um exagero'], c:1, e:'Dado verific√°vel: 200 livros.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"Choveu 20 mm ontem."', q:'Qual √© opini√£o?', a:['Choveu 20 mm','Foi chuva forte','Ontem choveu','Houve precipita√ß√£o'], c:1, e:'"Forte" √© avalia√ß√£o.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"O filme teve 1 milh√£o de espectadores."', q:'Marque a opini√£o:', a:['1 milh√£o de espectadores','Foi o melhor do ano','Houve muitas sess√µes','Dados s√£o oficiais'], c:1, e:'"Melhor do ano" √© ju√≠zo de valor.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Devemos plantar √°rvores, pois reduzem o calor."', q:'Qual √© o argumento?', a:['Plantar √°rvores','Reduzem o calor','A cidade √© quente','Pra√ßas s√£o bonitas'], c:1, e:'A raz√£o √© reduzir o calor.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"A pr√°tica de esportes melhora a sa√∫de; por isso, deve ser incentivada."', q:'Qual √© a tese?', a:['Melhora a sa√∫de','Deve ser incentivada','Alunos gostam','√â tend√™ncia'], c:1, e:'Tese: incentivar a pr√°tica.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Nota: "Reuni√£o √†s 8h, sala 12"', q:'Onde ser√° a reuni√£o?', a:['Sala 10','Sala 11','Sala 12','Sala 13'], c:2, e:'Sala 12.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Calend√°rio: "A prova ser√° na sexta-feira"', q:'Em que dia ser√° a prova?', a:['Quarta','Quinta','Sexta','S√°bado'], c:2, e:'Sexta-feira.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Carlos levou casaco grosso ap√≥s ouvir a previs√£o.', q:'O que se infere?', a:['Vai fazer calor','Pode esfriar','Vai chover','Vai ventar'], c:1, e:'Casaco grosso ‚Üí frio.'}
  ]},
  { name:'M√©dia', items:[
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Carlos chegou encharcado e deixou o casaco secando.', q:'Prov√°vel causa:', a:['Neve','Chuva','Calor','Vento'], c:1, e:'Encharcado ‚Üí chuva.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'O mercado fechou as portas e baixou as luzes √†s 22h.', q:'O que se infere?', a:['Abertura','Intervalo','Encerramento','Promo√ß√£o'], c:2, e:'Sinais de encerramento.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Mariana levou protetor solar e chap√©u para a trilha.', q:'O que se infere?', a:['Vai chover','Dia ensolarado','Passeio noturno','Neve'], c:1, e:'Itens indicam sol.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Relat√≥rio: "Foram coletadas 250 amostras no trimestre"', q:'Quantas amostras?', a:['150','200','250','300'], c:2, e:'N√∫mero literal: 250.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Edital: "provas nos dias 3 e 4 de junho"', q:'Quantos dias de prova?', a:['1','2','3','4'], c:1, e:'3 e 4 ‚Üí duas datas.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"O time marcou tr√™s gols."', q:'Qual √© opini√£o?', a:['Tr√™s gols','Vit√≥ria foi linda','Houve gols','Placar teve 3 gols'], c:1, e:'"Linda" √© ju√≠zo de valor.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"A campanha vacinou 12.000 pessoas."', q:'Qual √© opini√£o?', a:['12.000 pessoas','Cobertura foi excelente','Houve vacina√ß√£o','Meta atingida'], c:1, e:'"Excelente" = avalia√ß√£o.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"O uso de bicicletas deve ser incentivado porque diminui o tr√¢nsito."', q:'Qual √© a tese?', a:['Diminuir o tr√¢nsito','Incentivar bicicletas','Carros poluem','Ciclovias s√£o caras'], c:1, e:'Tese: incentivar bicicletas.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Merenda saud√°vel deve ser adotada, pois melhora a aprendizagem."', q:'Qual √© o argumento?', a:['Adotar merenda saud√°vel','Melhora a aprendizagem','Alunos gostam','√â moda'], c:1, e:'Raz√£o: melhora da aprendizagem.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Bibliotecas em tempo integral reduzem a evas√£o; por isso, devem ser ampliadas."', q:'Qual √© o argumento?', a:['Reduzem a evas√£o','Devem ser ampliadas','Alunos leem mais','Livros s√£o caros'], c:0, e:'Raz√£o: reduzir evas√£o.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Nota: "Entrega at√© 18h de ter√ßa"', q:'Prazo de entrega:', a:['18h de segunda','18h de ter√ßa','18h de quarta','20h de ter√ßa'], c:1, e:'18h de ter√ßa.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Cartaz: "Exposi√ß√£o de 2 a 15 de agosto"', q:'Dura√ß√£o do evento:', a:['1 dia','7 dias','14 dias','15 dias'], c:2, e:'2 a 15 ‚Üí 14 dias.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Pedro desligou o despertador e correu para o ponto.', q:'O que se infere?', a:['Acordou cedo demais','Est√° atrasado','Vai de carro','√â feriado'], c:1, e:'Correr para o ponto ‚Üí atraso.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"A feira recebeu 5.000 visitantes; foi a melhor de todas."', q:'Qual √© fato?', a:['Foi a melhor de todas','Recebeu 5.000 visitantes','Todos adoraram','Organiza√ß√£o perfeita'], c:1, e:'N√∫mero verific√°vel.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Aulas de educa√ß√£o financeira devem ser obrigat√≥rias, pois ajudam no planejamento."', q:'Qual √© a tese?', a:['Ajudam no planejamento','Devem ser obrigat√≥rias','Juros s√£o altos','Poupar √© dif√≠cil'], c:1, e:'Tese: tornar obrigat√≥rias.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Agenda: "Reuni√£o remarcada para 14h"', q:'Novo hor√°rio:', a:['10h','11h','14h','16h'], c:2, e:'Remarcada para 14h.'}
  ]},
  { name:'Dif√≠cil', items:[
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"A coleta seletiva deve ser obrigat√≥ria; assim, diminuiremos o lixo nos aterros."', q:'Qual √© a tese?', a:['Diminuir o lixo','Obrigatoriedade da coleta seletiva','Pessoas reciclam pouco','Aterros s√£o caros'], c:1, e:'Tese: tornar obrigat√≥ria.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Transporte p√∫blico gratuito deve ser adotado, pois aumenta o acesso e reduz carros."', q:'Qual argumento principal?', a:['Reduz carros','√â gratuito','√înibus s√£o confort√°veis','Carros s√£o ruins'], c:0, e:'Raz√£o: reduzir carros (e ampliar acesso).'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Para melhorar a mobilidade, a cidade precisa priorizar ciclovias."', q:'O que √© tese?', a:['Melhorar a mobilidade','Priorizar ciclovias','Menos acidentes','Mais √¥nibus'], c:1, e:'Tese: priorizar ciclovias.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'O vendedor fechou a porta e virou a placa para "Fechado".', q:'Momento inferido:', a:['Abertura','Intervalo','Fechamento','Promo√ß√£o'], c:2, e:'Placa ‚Üí encerramento.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Ana atrasou porque o √¥nibus quebrou no caminho.', q:'O que se infere?', a:['Ela saiu tarde','Imprevisto no transporte','Ela esqueceu o rel√≥gio','Houve greve'], c:1, e:'Quebra do √¥nibus ‚Üí imprevisto.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'O t√©cnico pediu tempo e reorganizou o time.', q:'O que se infere?', a:['O time vencia f√°cil','Havia problema t√°tico','Jogo terminou','Choveu'], c:1, e:'Pedido de tempo ‚Üí ajuste t√°tico.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"A nova lei reduziu em 15% os acidentes em um ano."', q:'Qual √© opini√£o?', a:['Reduziu 15%','Foi um grande sucesso','Houve diminui√ß√£o','Dados de um ano'], c:1, e:'"Grande sucesso" √© avalia√ß√£o.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"A cidade possui 120 pra√ßas bem cuidadas."', q:'Assinale a opini√£o:', a:['120 pra√ßas','Bem cuidadas','Cidade possui pra√ßas','H√° muitas √°reas verdes'], c:1, e:'"Bem cuidadas" √© valorativo.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Nota t√©cnica: "A m√©dia subiu de 4,2 para 4,8"', q:'Qual era a m√©dia anterior?', a:['4,0','4,1','4,2','4,5'], c:2, e:'Anterior: 4,2.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Relat√≥rio: "Foram 18 interven√ß√µes ao longo de 6 meses"', q:'Interven√ß√µes realizadas:', a:['12','15','18','20'], c:2, e:'Expl√≠cito: 18.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Para preservar rios, √© necess√°rio reduzir esgoto sem tratamento."', q:'Qual √© o argumento?', a:['Preservar rios','Reduzir esgoto sem tratamento','Mais multas','Plantar √°rvores'], c:1, e:'Raz√£o: reduzir esgoto.'},
    {desc:{code:'D8',text:'Identificar argumenta√ß√£o (tese √ó argumento)'}, ctx:'"Os parques devem abrir √† noite, pois aumentam o lazer seguro."', q:'Tese ou argumento?', a:['Tese: abrir √† noite','Argumento: abrir √† noite','Tese: lazer seguro','Argumento: parques s√£o bonitos'], c:0, e:'Tese = abrir √† noite; raz√£o = lazer seguro.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'Beatriz fechou o livro e apagou a luz da biblioteca.', q:'O que se infere?', a:['In√≠cio da leitura','Fim do hor√°rio','Intervalo','Chegada de amigos'], c:1, e:'A√ß√µes ‚Üí encerramento.'},
    {desc:{code:'D14',text:'Diferenciar fato de opini√£o'}, ctx:'"O projeto atendeu 900 fam√≠lias e foi espetacular."', q:'Qual √© fato?', a:['Atendeu 900 fam√≠lias','Foi espetacular','Mudou a cidade','Todos aprovaram'], c:0, e:'N√∫mero √© verific√°vel.'},
    {desc:{code:'D1',text:'Localizar informa√ß√µes expl√≠citas'}, ctx:'Agenda: "Entrega do relat√≥rio dia 28/09"', q:'Data da entrega:', a:['26/09','27/09','28/09','30/09'], c:2, e:'Expl√≠cito: 28/09.'},
    {desc:{code:'D4',text:'Inferir informa√ß√µes impl√≠citas'}, ctx:'A professora recolheu as folhas e pediu sil√™ncio.', q:'O que se infere?', a:['In√≠cio de prova','Fim da aula','Recreio','Apresenta√ß√£o'], c:0, e:'Sil√™ncio + recolher folhas ‚Üí prova.'}
  ]}
];

const QUESTIONS_PER_PHASE = 8; // 8 por fase
const MAX_LIVES = 3, TIME = 40;
let phase = 0, pool = [], asked = 0, lives = MAX_LIVES, score = 0, timer = null, timeLeft = TIME;

const $ = s => document.querySelector(s);
const el = { student:$('#student'), start:$('#start'), restart:$('#restart'), score:$('#score'), lives:$('#lives'), time:$('#time'), timeChip:$('#timeChip'), context:$('#context'), question:$('#question'), descriptor:$('#descriptor'), answers:$('#answers'), explain:$('#explain'), progress:$('#progress'), saveScore:$('#saveScore'), ranking:$('#ranking'), resetRanking:$('#resetRanking') };

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a }
function fmtHearts(n){ return '‚ù§'.repeat(n) }
function calcPoints(t){ return t>=30?100:t>=20?70:t>=10?40:10 }

function buildPool(phaseObj){
  const all = phaseObj.items.map((_,qi)=>({qi}));
  return shuffle(all).slice(0, Math.min(QUESTIONS_PER_PHASE, phaseObj.items.length));
}

function tick(startAt){
  timeLeft = startAt; el.time.textContent = timeLeft+'s';
  el.timeChip?.classList.remove('alert');
  clearInterval(timer);
  timer = setInterval(()=>{
    timeLeft--; el.time.textContent=timeLeft+'s';
    if(timeLeft<=10) el.timeChip?.classList.add('alert');
    if(timeLeft<=0){ clearInterval(timer); answer(null,false); }
  },1000);
}

function start(){
  const name = el.student.value.trim();
  if(!name){ alert('Digite o nome do(a) aluno(a).'); return; }
  phase = 0; lives = MAX_LIVES; score = 0; asked = 0; pool = buildPool(PHASES[phase]);
  el.lives.textContent = fmtHearts(lives); el.score.textContent = score; el.explain.style.display='none';
  el.restart.classList.add('hidden'); el.saveScore.classList.add('hidden');
  next();
}

function showPhaseBanner(){
  const p = PHASES[phase];
  el.context.innerHTML = `<strong>Fase conclu√≠da!</strong><br>Voc√™ avan√ßou para <em>${p.name}</em>.<br><br><button id="continueBtn" class="primary">Continuar</button>`;
  el.question.textContent=''; el.descriptor.textContent='';
  el.answers.innerHTML=''; el.explain.style.display='none';
  el.progress.textContent = `Fase ${phase+1}/${PHASES.length}`;
  document.getElementById('continueBtn').addEventListener('click', ()=>{ next(); });
}

function next(){
  clearInterval(timer);
  if(lives<=0){ return end(); }
  if(asked>=pool.length){
    phase++;
    if(phase>=PHASES.length){ return end(); }
    asked = 0; pool = buildPool(PHASES[phase]);
    return showPhaseBanner();
  }
  const item = PHASES[phase].items[ pool[asked++].qi ];

  el.context.textContent = item.ctx;
  el.question.textContent = item.q;
  el.descriptor.innerHTML = `<strong>[${item.desc.code}] ${item.desc.text}</strong>`;
  el.explain.textContent = ''; el.explain.style.display = 'none';

  el.answers.innerHTML = '';
  const opts = shuffle(item.a.map((t,i)=>({t,i})));
  for(const opt of opts){
    const b = document.createElement('button');
    b.className = 'ans'; b.type = 'button'; b.textContent = opt.t;
    b.addEventListener('click',()=>answer(b, opt.i===item.c, item));
    el.answers.appendChild(b);
  }
  el.progress.textContent = `Fase ${phase+1}/${PHASES.length} ¬∑ Quest√£o ${asked} de ${pool.length}`;
  tick(TIME);
}

function answer(btn, ok, item){
  clearInterval(timer);
  Array.from(el.answers.children).forEach(b=> b.disabled=true);
  if(btn) btn.classList.add(ok?'ok':'no');
  if(ok){ score += calcPoints(timeLeft); el.score.textContent = score; } else { lives--; el.lives.textContent = fmtHearts(lives); }
  el.explain.textContent = (ok?'Acertou! ':'N√£o foi dessa vez. ') + (item?.e || '');
  el.explain.className = 'explain ' + (ok ? 'ok' : 'no');
  el.explain.style.display = 'block';
  setTimeout(next, 900);
}

function end(){
  clearInterval(timer);
  el.context.innerHTML = `<strong>Fim!</strong> Voc√™ concluiu todas as fases com pontua√ß√£o <strong>${score}</strong>.`;
  el.question.textContent=''; el.descriptor.textContent=''; el.answers.innerHTML='';
  el.explain.style.display='none'; el.progress.textContent='';
  el.restart.classList.remove('hidden'); el.saveScore.classList.remove('hidden');
}

// Ranking persistente
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
function renderRanking(){
  const data=JSON.parse(localStorage.getItem('rank_idedb_em'))||[];
  const top10 = data.slice(0,10);
  el.ranking.innerHTML = top10.map((r,i)=>`<li>${i+1}. ${escapeHtml(r.name)} ‚Äî <strong>${r.score}</strong> pts</li>`).join('');
}
el.saveScore.addEventListener('click', ()=>{
  const name = el.student.value.trim();
  if(!name){ alert('Sem nome n√£o d√° pra salvar üòÖ'); return; }
  const data = JSON.parse(localStorage.getItem('rank_idedb_em'))||[];
  data.push({ name, score, at:new Date().toISOString() });
  data.sort((a,b)=> b.score - a.score);
  localStorage.setItem('rank_idedb_em', JSON.stringify(data.slice(0,50)));
  el.saveScore.classList.add('hidden');
  renderRanking();
});

// Controles
el.start.addEventListener('click', start);
el.restart.addEventListener('click', start);
el.resetRanking.addEventListener('click', ()=>{ localStorage.removeItem('rank_idedb_em'); renderRanking(); alert('Ranking zerado!'); });

// Init
renderRanking();
  </script>
</body>
</html>
